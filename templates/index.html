<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eaglearn | Focus Monitoring</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        :root {
            /* Professional Color Palette - High Class */
            --primary: #0a0a0a;
            --primary-light: #1a1a1a;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text-primary: #ffffff;
            --text-secondary: #a3a3a3;
            --text-muted: #737373;
            --border: #262626;
            --card-bg: #171717;
            --input-bg: #262626;

            /* Spacing */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;

            /* Radius */
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Inter', 'Segoe UI', sans-serif;
            background: var(--primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            padding: var(--space-lg);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 var(--space-lg);
        }

        /* Header - Clean, Professional */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-xl);
            padding-bottom: var(--space-lg);
            border-bottom: 1px solid var(--border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: var(--accent);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 700;
        }

        .logo-text {
            font-size: 28px;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .logo-text span {
            color: var(--text-secondary);
            font-weight: 400;
        }

        .header-actions {
            display: flex;
            gap: var(--space-sm);
        }

        /* Buttons - Modern, Minimal */
        .btn {
            padding: var(--space-sm) var(--space-lg);
            border: none;
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-secondary {
            background: var(--card-bg);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--primary-light);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Grid Layout - Optimized */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 450px;
            gap: var(--space-lg);
            align-items: start;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (min-width: 1600px) {
            .main-grid {
                grid-template-columns: 1fr 500px;
            }
        }

        /* Cards - Clean, Elegant */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .card-header {
            padding: var(--space-lg);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            letter-spacing: -0.3px;
        }

        .card-body {
            padding: var(--space-lg);
        }

        /* Webcam Container - Optimized */
        #webcam-container {
            position: relative;
            background: #000;
            border-radius: var(--radius-md);
            overflow: hidden;
            max-height: 70vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #webcam-feed {
            width: 100%;
            height: auto;
            max-height: 70vh;
            object-fit: contain;
            display: block;
        }

        .webcam-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            padding: var(--space-lg);
            display: flex;
            gap: var(--space-lg);
        }

        .overlay-item {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            font-size: 14px;
        }

        .overlay-label {
            color: var(--text-secondary);
        }

        .overlay-value {
            font-weight: 600;
            font-size: 16px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }

        .stat-card {
            background: var(--primary-light);
            padding: var(--space-lg);
            border-radius: var(--radius-md);
            text-align: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: var(--space-xs);
            letter-spacing: -1px;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Focus Meter */
        .focus-meter {
            margin-bottom: var(--space-lg);
        }

        .meter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-sm);
        }

        .meter-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .meter-value {
            font-size: 24px;
            font-weight: 700;
        }

        .meter-bar {
            height: 8px;
            background: var(--primary-light);
            border-radius: 4px;
            overflow: hidden;
        }

        .meter-fill {
            height: 100%;
            background: var(--accent);
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        /* Status Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: var(--space-xs) var(--space-md);
            border-radius: var(--radius-sm);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .badge-danger {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        /* Emotion Display */
        .emotion-display {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }

        .emotion-icon {
            width: 64px;
            height: 64px;
            background: var(--primary-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
        }

        .emotion-info {
            flex: 1;
        }

        .emotion-name {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: var(--space-xs);
        }

        .emotion-confidence {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Distractions List */
        .distractions-list {
            margin-top: var(--space-md);
        }

        .distraction-item {
            padding: var(--space-md);
            background: var(--primary-light);
            border-radius: var(--radius-sm);
            margin-bottom: var(--space-sm);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .distraction-item:last-child {
            margin-bottom: 0;
        }

        /* Info Banner */
        .info-banner {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            margin-bottom: var(--space-lg);
        }

        .info-banner-title {
            font-weight: 600;
            color: var(--accent);
            margin-bottom: var(--space-xs);
        }

        .info-banner-text {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* Disclaimer */
        .disclaimer {
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.5;
            margin-top: var(--space-lg);
            padding-top: var(--space-lg);
            border-top: 1px solid var(--border);
        }

        /* Animation */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .recording-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--danger);
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">E</div>
                <div class="logo-text">Eaglearn <span>Focus Monitor</span></div>
            </div>
            <div class="header-actions">
                <button id="calibrateBtn" class="btn btn-secondary" onclick="startCalibration()">
                    Calibrate Gaze
                </button>
                <button id="toggleBtn" class="btn btn-secondary" onclick="toggleProcessing()">
                    Pause
                </button>
                <button id="startBtn" class="btn btn-primary" onclick="startSession()">
                    Start Monitoring
                </button>
            </div>
        </header>

        <!-- Disclaimer Banner -->
        <div class="info-banner">
            <div class="info-banner-title">‚ÑπÔ∏è Accuracy Information</div>
            <div class="info-banner-text">
                ‚Ä¢ <strong>Emotion Detection:</strong> 93% accurate (DeepFace pre-trained model)<br>
                ‚Ä¢ <strong>Gaze Tracking:</strong> ~80-85% accurate with calibration, marked as experimental<br>
                ‚Ä¢ <strong>Focus Monitoring:</strong> Reliable for general attention tracking
            </div>
        </div>

        <!-- Main Grid -->
        <div class="main-grid">
            <!-- Left Column - Webcam -->
            <div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <span id="recordingIndicator" class="recording-indicator" style="display:none"></span>
                            Camera Feed
                        </div>
                        <span id="sessionStatus" class="badge badge-warning">Stopped</span>
                    </div>
                    <div id="webcam-container">
                        <img id="webcam-feed" src="" alt="Camera feed will appear here">
                    </div>
                    <div class="card-body">
                        <div class="webcam-overlay">
                            <div class="overlay-item">
                                <span class="overlay-label">FPS:</span>
                                <span class="overlay-value" id="fpsValue">0</span>
                            </div>
                            <div class="overlay-item">
                                <span class="overlay-label">Faces:</span>
                                <span class="overlay-value" id="faceCount">0</span>
                            </div>
                            <div class="overlay-item">
                                <span class="overlay-label">Frame:</span>
                                <span class="overlay-value" id="frameCount">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Stats -->
            <div>
                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="focusPercentage">0%</div>
                        <div class="stat-label">Focus Score</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="focusedTime">00:00:00</div>
                        <div class="stat-label">Focused Time</div>
                    </div>
                </div>

                <!-- AI Analysis & Suggestions - MOVED TO TOP -->
                <div class="card" style="margin-bottom: var(--space-lg);">
                    <div class="card-header">
                        <div class="card-title">ü§ñ AI Analysis & Suggestions</div>
                    </div>
                    <div class="card-body">
                        <div id="interpretation" style="margin-bottom: var(--space-md);">
                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">üìä Interpretation:</div>
                            <div id="interpretationText" style="font-size: 13px; color: var(--text-secondary); line-height: 1.5;">
                                Waiting for data...
                            </div>
                        </div>
                        <div id="suggestions">
                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">üí° Suggestions:</div>
                            <div id="suggestionsText" style="font-size: 13px; color: var(--text-secondary); line-height: 1.5;">
                                Start monitoring to receive personalized suggestions
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Focus Meter -->
                <div class="card" style="margin-bottom: var(--space-lg);">
                    <div class="card-header">
                        <div class="card-title">Focus Level</div>
                        <span id="focusStatus" class="badge badge-warning">Unknown</span>
                    </div>
                    <div class="card-body">
                        <div class="focus-meter">
                            <div class="meter-header">
                                <span class="meter-label">Percentage</span>
                                <span class="meter-value" id="focusMeterValue">0%</span>
                            </div>
                            <div class="meter-bar">
                                <div class="meter-fill" id="focusMeterFill" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Emotion -->
                <div class="card" style="margin-bottom: var(--space-lg);">
                    <div class="card-header">
                        <div class="card-title">Emotion Detection</div>
                        <span class="badge" style="background: rgba(16, 185, 129, 0.15); color: var(--success);">DeepFace 93%</span>
                    </div>
                    <div class="card-body">
                        <div class="emotion-display">
                            <div class="emotion-icon" id="emotionIcon">üòê</div>
                            <div class="emotion-info">
                                <div class="emotion-name" id="emotionName">Neutral</div>
                                <div class="emotion-confidence" id="emotionConfidence">Confidence: 50%</div>
                            </div>
                        </div>
                        <div style="margin-top: var(--space-md); padding-top: var(--space-md); border-top: 1px solid var(--border);">
                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: var(--space-xs);">All Emotion Scores:</div>
                            <div id="emotionScores" style="font-size: 12px; line-height: 1.8; color: var(--text-secondary);">
                                <div>Happy: <span id="scoreHappy">0%</span></div>
                                <div>Sad: <span id="scoreSad">0%</span></div>
                                <div>Angry: <span id="scoreAngry">0%</span></div>
                                <div>Surprised: <span id="scoreSurprised">0%</span></div>
                                <div>Neutral: <span id="scoreNeutral">0%</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gaze Tracking -->
                <div class="card" style="margin-bottom: var(--space-lg);">
                    <div class="card-header">
                        <div class="card-title">Gaze Tracking</div>
                        <span class="badge" style="background: rgba(245, 158, 11, 0.15); color: var(--warning);">Experimental</span>
                    </div>
                    <div class="card-body">
                        <div style="margin-bottom: var(--space-sm);">
                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Looking Direction:</div>
                            <div style="font-size: 14px; font-weight: 600; color: var(--text-primary);" id="lookingAt">Center</div>
                        </div>
                        <div style="margin-bottom: var(--space-sm);">
                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Attention Score:</div>
                            <div style="font-size: 14px; font-weight: 600; color: var(--text-primary);" id="attentionScore">100%</div>
                        </div>
                        <div>
                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Gaze Coordinates:</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">X: <span id="gazeX">0.00</span> | Y: <span id="gazeY">0.00</span></div>
                        </div>
                        <div style="margin-top: var(--space-sm); padding-top: var(--space-sm); border-top: 1px solid var(--border); font-size: 10px; color: var(--text-muted);">
                            ‚ö†Ô∏è Experimental - ~80-85% accurate with calibration
                        </div>
                    </div>
                </div>

                <!-- Head & Body Metrics -->
                <div class="card" style="margin-bottom: var(--space-lg);">
                    <div class="card-header">
                        <div class="card-title">Head & Body Pose</div>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md); font-size: 12px;">
                            <div>
                                <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 4px;">Head Yaw</div>
                                <div style="color: var(--text-primary); font-weight: 500;" id="headYaw">0¬∞</div>
                            </div>
                            <div>
                                <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 4px;">Head Pitch</div>
                                <div style="color: var(--text-primary); font-weight: 500;" id="headPitch">0¬∞</div>
                            </div>
                            <div>
                                <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 4px;">Head Roll</div>
                                <div style="color: var(--text-primary); font-weight: 500;" id="headRoll">0¬∞</div>
                            </div>
                            <div>
                                <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 4px;">Posture Score</div>
                                <div style="color: var(--text-primary); font-weight: 500;" id="postureScore">0%</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Micro-expressions -->
                <div class="card" style="margin-bottom: var(--space-lg);">
                    <div class="card-header">
                        <div class="card-title">Micro-expressions</div>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md); font-size: 12px;">
                            <div>
                                <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 4px;">Blink Rate</div>
                                <div style="color: var(--text-primary); font-weight: 500;" id="blinkRate">0/min</div>
                            </div>
                            <div>
                                <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 4px;">Eye Aspect Ratio</div>
                                <div style="color: var(--text-primary); font-weight: 500;" id="eyeAspectRatio">0.00</div>
                            </div>
                            <div>
                                <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 4px;">Eyebrow Raise</div>
                                <div style="color: var(--text-primary); font-weight: 500;" id="eyebrowRaise">0%</div>
                            </div>
                            <div>
                                <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 4px;">Lip Tension</div>
                                <div style="color: var(--text-primary); font-weight: 500;" id="lipTension">0%</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Distractions -->
                <div class="card" style="margin-bottom: var(--space-lg);">
                    <div class="card-header">
                        <div class="card-title">Current Distractions</div>
                    </div>
                    <div class="card-body">
                        <div id="distractionsList" class="distractions-list">
                            <div class="distraction-item" style="color: var(--text-muted);">No distractions detected</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Eye Focus Point Visualization -->
    <div id="focusPoint" style="display: none; position: fixed; width: 20px; height: 20px; background: rgba(59, 130, 246, 0.6); border: 2px solid #3b82f6; border-radius: 50%; pointer-events: none; z-index: 9999; transform: translate(-50%, -50%); box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);"></div>

    <script>
        const socket = io();
        let sessionRunning = false;
        let processingPaused = false;

        // Throttle focus point updates to reduce lag (update every 100ms max)
        let lastFocusPointUpdate = 0;
        const FOCUS_POINT_THROTTLE = 100; // ms

        // Connect to server
        socket.on('connect', () => {
            console.log('Connected to server');
        });

        // Receive frame updates
        socket.on('frame_update', (data) => {
            const frame = data.frame;
            const state = data.state;

            // Update webcam feed
            document.getElementById('webcam-feed').src = 'data:image/jpeg;base64,' + frame;

            // Update stats
            updateUI(state);
        });

        // Update UI with state
        function updateUI(state) {
            // Stats
            document.getElementById('focusPercentage').textContent = Math.round(state.focus_percentage) + '%';
            document.getElementById('focusedTime').textContent = state.time_tracking.focused_time_formatted;
            document.getElementById('fpsValue').textContent = state.webcam.fps.toFixed(1);
            document.getElementById('faceCount').textContent = state.webcam.face_count;
            document.getElementById('frameCount').textContent = state.webcam.frame_count;

            // Focus meter
            document.getElementById('focusMeterValue').textContent = Math.round(state.focus_percentage) + '%';
            document.getElementById('focusMeterFill').style.width = state.focus_percentage + '%';

            // Focus status
            const focusStatus = document.getElementById('focusStatus');
            focusStatus.textContent = state.focus_status.charAt(0).toUpperCase() + state.focus_status.slice(1);

            if (state.focus_status === 'focused') {
                focusStatus.className = 'badge badge-success';
                document.getElementById('focusMeterFill').style.background = 'var(--success)';
            } else if (state.focus_status === 'distracted') {
                focusStatus.className = 'badge badge-warning';
                document.getElementById('focusMeterFill').style.background = 'var(--warning)';
            } else {
                focusStatus.className = 'badge badge-danger';
                document.getElementById('focusMeterFill').style.background = 'var(--danger)';
            }

            // Emotion
            const emotionIcons = {
                'neutral': 'üòê',
                'happy': 'üòä',
                'sad': 'üò¢',
                'angry': 'üò†',
                'surprised': 'üò≤',
                'fearful': 'üò®',
                'disgusted': 'ü§¢',
                'confused': 'ü§î',
                'content': 'üòå',
                'stressed': 'üò∞',
                'drowsy': 'üò¥'
            };

            document.getElementById('emotionIcon').textContent = emotionIcons[state.facial_metrics.emotion] || 'üòê';
            document.getElementById('emotionName').textContent = state.facial_metrics.emotion.charAt(0).toUpperCase() + state.facial_metrics.emotion.slice(1);
            document.getElementById('emotionConfidence').textContent = 'Confidence: ' + Math.round(state.facial_metrics.emotion_confidence * 100) + '%';

            // Emotion scores (if available from DeepFace)
            if (state.facial_metrics.emotion_scores && Object.keys(state.facial_metrics.emotion_scores).length > 0) {
                const scores = state.facial_metrics.emotion_scores;
                const updateScore = (id, value) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = Math.round(value) + '%';
                };
                updateScore('scoreHappy', scores.happy || 0);
                updateScore('scoreSad', scores.sad || 0);
                updateScore('scoreAngry', scores.angry || 0);
                updateScore('scoreSurprised', scores.surprise || 0);
                updateScore('scoreNeutral', scores.neutral || 0);
            } else {
                // Reset to 0% when no DeepFace scores available
                ['scoreHappy', 'scoreSad', 'scoreAngry', 'scoreSurprised', 'scoreNeutral'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = '0%';
                });
            }

            // Gaze tracking
            document.getElementById('lookingAt').textContent = state.facial_metrics.looking_at || 'Center';
            document.getElementById('attentionScore').textContent = Math.round(state.facial_metrics.attention_score || 100) + '%';
            document.getElementById('gazeX').textContent = (state.facial_metrics.eye_gaze_x || 0).toFixed(2);
            document.getElementById('gazeY').textContent = (state.facial_metrics.eye_gaze_y || 0).toFixed(2);

            // Head pose
            document.getElementById('headYaw').textContent = Math.round(state.facial_metrics.head_yaw || 0) + '¬∞';
            document.getElementById('headPitch').textContent = Math.round(state.facial_metrics.head_pitch || 0) + '¬∞';
            document.getElementById('headRoll').textContent = Math.round(state.facial_metrics.head_roll || 0) + '¬∞';
            document.getElementById('postureScore').textContent = Math.round(state.facial_metrics.posture_score || 0) + '%';

            // Micro-expressions
            document.getElementById('blinkRate').textContent = (state.facial_metrics.blink_rate || 0) + '/min';
            document.getElementById('eyeAspectRatio').textContent = (state.facial_metrics.eye_aspect_ratio || 0).toFixed(2);
            document.getElementById('eyebrowRaise').textContent = Math.round((state.facial_metrics.eyebrow_raise || 0) * 100) + '%';
            document.getElementById('lipTension').textContent = Math.round((state.facial_metrics.lip_tension || 0) * 100) + '%';

            // Interpretation & Suggestions
            updateInterpretationAndSuggestions(state);

            // Eye focus point on screen
            updateFocusPoint(state);

            // Distractions
            const distractionsList = document.getElementById('distractionsList');
            if (state.current_distractions.length > 0) {
                distractionsList.innerHTML = state.current_distractions.map(d =>
                    `<div class="distraction-item">${d}</div>`
                ).join('');
            } else {
                distractionsList.innerHTML = '<div class="distraction-item" style="color: var(--text-muted);">No distractions detected ‚úÖ</div>';
            }
        }

        // Start session
        async function startSession() {
            const btn = document.getElementById('startBtn');
            const status = document.getElementById('sessionStatus');
            const indicator = document.getElementById('recordingIndicator');

            try {
                if (!sessionRunning) {
                    const response = await fetch('/api/session/start', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    if (response.ok) {
                        sessionRunning = true;
                        btn.textContent = 'Stop Monitoring';
                        btn.className = 'btn btn-primary';
                        status.textContent = 'Running';
                        status.className = 'badge badge-success';
                        indicator.style.display = 'inline-block';
                    }
                } else {
                    const response = await fetch('/api/session/stop', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    if (response.ok) {
                        sessionRunning = false;
                        btn.textContent = 'Start Monitoring';
                        btn.className = 'btn btn-primary';
                        status.textContent = 'Stopped';
                        status.className = 'badge badge-warning';
                        indicator.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to toggle session');
            }
        }

        // Toggle processing (privacy)
        async function toggleProcessing() {
            const btn = document.getElementById('toggleBtn');

            try {
                const response = await fetch('/api/privacy/toggle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const data = await response.json();
                    processingPaused = !data.processing_enabled;
                    btn.textContent = processingPaused ? 'Resume' : 'Pause';
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Update interpretation and suggestions based on state
        function updateInterpretationAndSuggestions(state) {
            const interpretationEl = document.getElementById('interpretationText');
            const suggestionsEl = document.getElementById('suggestionsText');

            let interpretation = [];
            let suggestions = [];

            // Focus interpretation
            if (state.focus_percentage >= 80) {
                interpretation.push('‚úÖ Excellent focus level - you\'re highly attentive');
            } else if (state.focus_percentage >= 60) {
                interpretation.push('üëç Good focus - maintaining attention well');
            } else if (state.focus_percentage >= 40) {
                interpretation.push('‚ö†Ô∏è Moderate focus - some distractions detected');
            } else {
                interpretation.push('‚ùå Low focus - highly distracted or fatigued');
            }

            // Emotion interpretation
            const emotion = state.facial_metrics.emotion;
            if (emotion === 'happy') {
                interpretation.push('üòä Positive emotional state - great for learning');
                suggestions.push('‚Ä¢ Maintain this positive mindset for optimal retention');
            } else if (emotion === 'sad') {
                interpretation.push('üò¢ Low mood detected - may affect motivation');
                suggestions.push('‚Ä¢ Consider taking a short break to boost your mood');
            } else if (emotion === 'angry') {
                interpretation.push('üò† Frustration detected - challenging material?');
                suggestions.push('‚Ä¢ Take a deep breath - try breaking down complex topics');
            } else if (emotion === 'surprised') {
                interpretation.push('üò≤ Surprise indicates engagement with new information');
                suggestions.push('‚Ä¢ Good! Novelty enhances learning - keep exploring');
            }

            // Head pose interpretation
            const headTilt = Math.abs(state.facial_metrics.head_roll || 0);
            if (headTilt > 15) {
                interpretation.push('üìê Head tilting detected - possible fatigue or confusion');
                suggestions.push('‚Ä¢ Check your posture - sit upright for better focus');
            }

            // Blink rate interpretation
            const blinkRate = state.facial_metrics.blink_rate || 0;
            if (blinkRate < 10) {
                interpretation.push('üëÅÔ∏è Low blink rate - intense concentration (possible screen fixation)');
                suggestions.push('‚Ä¢ Remember to blink regularly to reduce eye strain');
            } else if (blinkRate > 25) {
                interpretation.push('üëÅÔ∏è High blink rate - possible fatigue or distraction');
                suggestions.push('‚Ä¢ Take a 5-minute break to rest your eyes');
            }

            // Eye aspect ratio (drowsiness)
            const ear = state.facial_metrics.eye_aspect_ratio || 0;
            if (ear < 0.2) {
                interpretation.push('üò¥ Eyes drooping - drowsiness detected');
                suggestions.push('‚ö†Ô∏è CRITICAL: You\'re drowsy. Take a break or rest!');
            }

            // Gaze tracking interpretation
            const attentionScore = state.facial_metrics.attention_score || 100;
            if (attentionScore < 70) {
                interpretation.push('üëÄ Gaze not centered - attention wandering');
                suggestions.push('‚Ä¢ Redirect your attention to the center of the screen');
            }

            // Update UI
            interpretationEl.textContent = interpretation.join(' | ') || 'Monitoring...';
            suggestionsEl.textContent = suggestions.join('\n') || '‚úÖ Everything looks good - keep going!';
        }

        // Update eye focus point on screen (throttled to reduce lag)
        function updateFocusPoint(state) {
            const now = Date.now();

            // Skip update if too soon (throttling)
            if (now - lastFocusPointUpdate < FOCUS_POINT_THROTTLE) {
                return;
            }
            lastFocusPointUpdate = now;

            const focusPoint = document.getElementById('focusPoint');
            const gazeX = state.facial_metrics.eye_gaze_x || 0;
            const gazeY = state.facial_metrics.eye_gaze_y || 0;

            // Only show focus point if monitoring is running
            if (sessionRunning && state.face_detected) {
                focusPoint.style.display = 'block';

                // Map gaze coordinates (-1 to 1) to screen coordinates
                // gazeX: -1 (left) to 1 (right)
                // gazeY: -1 (up) to 1 (down)
                const screenX = ((gazeX + 1) / 2) * window.innerWidth;
                const screenY = ((gazeY + 1) / 2) * window.innerHeight;

                focusPoint.style.left = screenX + 'px';
                focusPoint.style.top = screenY + 'px';

                // Change color based on attention
                const attention = state.facial_metrics.attention_score || 100;
                if (attention >= 80) {
                    focusPoint.style.background = 'rgba(16, 185, 129, 0.6)';
                    focusPoint.style.borderColor = '#10b981';
                } else if (attention >= 60) {
                    focusPoint.style.background = 'rgba(245, 158, 11, 0.6)';
                    focusPoint.style.borderColor = '#f59e0b';
                } else {
                    focusPoint.style.background = 'rgba(239, 68, 68, 0.6)';
                    focusPoint.style.borderColor = '#ef4444';
                }
            } else {
                focusPoint.style.display = 'none';
            }
        }

        // ENHANCED: Start calibration - 9-point calibration wizard with visual feedback
        let calibrationState = {
            active: false,
            currentPoint: 0,
            points: [
                { x: 10, y: 10, name: 'Top Left' },
                { x: 50, y: 10, name: 'Top Center' },
                { x: 90, y: 10, name: 'Top Right' },
                { x: 10, y: 50, name: 'Middle Left' },
                { x: 50, y: 50, name: 'Center' },
                { x: 90, y: 50, name: 'Middle Right' },
                { x: 10, y: 90, name: 'Bottom Left' },
                { x: 50, y: 90, name: 'Bottom Center' },
                { x: 90, y: 90, name: 'Bottom Right' }
            ],
            gazeData: [],
            qualityScores: [], // Track quality for each point
            startTime: null,
            pointStartTime: null
        };

        function startCalibration() {
            if (calibrationState.active) {
                // Cancel calibration
                calibrationState.active = false;
                document.getElementById('calibrationOverlay').style.display = 'none';
                document.getElementById('calibrateBtn').textContent = 'üéØ Calibrate Gaze';
                socket.emit('calibration_cancel');
                return;
            }

            // Start calibration
            calibrationState.active = true;
            calibrationState.currentPoint = 0;
            calibrationState.gazeData = [];
            calibrationState.qualityScores = [];
            calibrationState.startTime = Date.now();

            // Show calibration overlay
            const overlay = document.getElementById('calibrationOverlay');
            overlay.style.display = 'flex';
            document.getElementById('calibrateBtn').textContent = '‚ùå Cancel Calibration';

            // Reset progress display
            updateCalibrationProgress(0, 0);

            // Start first point
            showCalibrationPoint(0);

            // Notify backend
            socket.emit('calibration_start');
        }

        function showCalibrationPoint(index) {
            if (index >= calibrationState.points.length) {
                // All points done
                finishCalibration();
                return;
            }

            const point = calibrationState.points[index];
            const target = document.getElementById('calibrationTarget');
            const info = document.getElementById('calibrationInfo');

            // Position target
            target.style.left = point.x + '%';
            target.style.top = point.y + '%';

            // Update info with countdown
            info.innerHTML = `Look at the <strong>${point.name}</strong> point (${index + 1}/9)<br><span id="countdown" style="font-size: 36px; color: #3b82f6;">3</span>`;

            // Collect data for this point
            calibrationState.currentPoint = index;
            calibrationState.pointStartTime = Date.now();
            calibrationState.gazeData.push({
                point: point,
                samples: []
            });

            // Countdown timer
            let countdown = 3;
            const countdownEl = document.getElementById('countdown');
            const countdownInterval = setInterval(() => {
                countdown--;
                if (countdownEl) countdownEl.textContent = countdown;

                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    // Move to next point
                    if (calibrationState.active && index < calibrationState.points.length - 1) {
                        setTimeout(() => showCalibrationPoint(index + 1), 200);
                    } else if (index === calibrationState.points.length - 1) {
                        finishCalibration();
                    }
                }
            }, 1000);
        }

        function updateCalibrationProgress(currentPoint, sampleCount) {
            const progressEl = document.getElementById('calibrationProgress');
            const samplesEl = document.getElementById('sampleCount');
            const qualityEl = document.getElementById('qualityIndicator');

            if (progressEl) {
                const progress = ((currentPoint + 1) / 9) * 100;
                progressEl.style.width = progress + '%';
                progressEl.textContent = `${currentPoint + 1}/9`;
            }

            if (samplesEl) {
                samplesEl.textContent = `Samples: ${sampleCount}`;
            }

            // Update quality indicator based on sample count and stability
            if (qualityEl && sampleCount > 0) {
                const quality = Math.min(100, (sampleCount / 30) * 100);
                if (quality >= 80) {
                    qualityEl.innerHTML = '‚úÖ Excellent';
                    qualityEl.style.color = '#22c55e';
                } else if (quality >= 50) {
                    qualityEl.innerHTML = '‚ö†Ô∏è Good';
                    qualityEl.style.color = '#eab308';
                } else {
                    qualityEl.innerHTML = '‚ùå Poor';
                    qualityEl.style.color = '#ef4444';
                }
            }
        }

        function finishCalibration() {
            // Calculate overall quality score
            let totalSamples = 0;
            let qualityPoints = 0;

            calibrationState.gazeData.forEach(pointData => {
                const samples = pointData.samples.length;
                totalSamples += samples;

                // Calculate stability (standard deviation)
                if (samples > 10) {
                    const xValues = pointData.samples.map(s => s.x);
                    const yValues = pointData.samples.map(s => s.y);

                    const xStd = Math.sqrt(xValues.map(x => Math.pow(x - xValues.reduce((a, b) => a + b) / xValues.length, 2)).reduce((a, b) => a + b) / xValues.length);
                    const yStd = Math.sqrt(yValues.map(y => Math.pow(y - yValues.reduce((a, b) => a + b) / yValues.length, 2)).reduce((a, b) => a + b) / yValues.length);

                    const stability = Math.max(0, 100 - (xStd + yStd) * 100);
                    qualityPoints += stability;
                }
            });

            const avgQuality = qualityPoints / 9;
            const duration = ((Date.now() - calibrationState.startTime) / 1000).toFixed(1);

            // Hide overlay
            document.getElementById('calibrationOverlay').style.display = 'none';
            document.getElementById('calibrateBtn').textContent = 'üéØ Calibrate Gaze';
            calibrationState.active = false;

            // Send data to backend
            socket.emit('calibration_complete', {
                data: calibrationState.gazeData
            });

            // Show detailed success message
            const qualityText = avgQuality >= 80 ? 'Excellent' : avgQuality >= 60 ? 'Good' : 'Fair';
            const qualityEmoji = avgQuality >= 80 ? 'üåü' : avgQuality >= 60 ? 'üëç' : '‚úÖ';

            alert(`${qualityEmoji} Calibration Complete!\n\n` +
                  `Duration: ${duration}s\n` +
                  `Total Samples: ${totalSamples}\n` +
                  `Quality Score: ${qualityText} (${avgQuality.toFixed(0)}%)\n\n` +
                  `Your gaze tracking is now calibrated.\n` +
                  `Expected accuracy improvement: ~10-15%`);
        }

        // Collect gaze data during calibration from state updates
        socket.on('frame_update', function(data) {
            if (calibrationState.active && calibrationState.gazeData.length > 0) {
                const state = data.state;
                if (state && state.eye_gaze_x !== undefined) {
                    const currentData = calibrationState.gazeData[calibrationState.currentPoint];
                    if (currentData && currentData.samples) {
                        currentData.samples.push({
                            x: state.eye_gaze_x,
                            y: state.eye_gaze_y,
                            timestamp: Date.now()
                        });

                        // Update progress display
                        updateCalibrationProgress(calibrationState.currentPoint, currentData.samples.length);
                    }
                }
            }
        });

        // Update button state
        document.getElementById('startBtn').addEventListener('click', startSession);
    </script>

    <!-- ENHANCED: Calibration Overlay with Progress Tracking -->
    <div id="calibrationOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10, 10, 10, 0.95); z-index: 1000; flex-direction: column; align-items: center; justify-content: center;">

        <!-- Progress Bar -->
        <div style="position: absolute; top: 40px; width: 400px; max-width: 90%; background: rgba(255, 255, 255, 0.1); border-radius: 10px; overflow: hidden;">
            <div id="calibrationProgress" style="height: 8px; background: linear-gradient(90deg, #3b82f6, #8b5cf6); width: 0%; transition: width 0.3s ease;"></div>
        </div>
        <div style="position: absolute; top: 55px; color: #a3a3a3; font-size: 14px;">
            <span id="sampleCount">Samples: 0</span> | <span id="qualityIndicator">Waiting...</span>
        </div>

        <!-- Main Info -->
        <div id="calibrationInfo" style="color: #fff; font-size: 24px; margin-bottom: 40px; font-weight: 600; text-align: center;">
            Look at the point
        </div>

        <!-- Target Point -->
        <div id="calibrationTarget" style="position: absolute; width: 40px; height: 40px; background: #3b82f6; border: 5px solid #fff; border-radius: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 30px rgba(59, 130, 246, 0.8); animation: pulse 1s infinite;"></div>

        <!-- Instructions -->
        <div style="color: #a3a3a3; font-size: 16px; margin-top: 60px; max-width: 600px; text-align: center;">
            <p style="margin-bottom: 12px;">üéØ <strong>9-Point Calibration</strong></p>
            <p>Follow the blue dot with your eyes. Keep your head still and look directly at each point.</p>
            <p style="margin-top: 12px; font-size: 14px; color: #737373;">Each point takes 3 seconds ‚Ä¢ Click "Cancel Calibration" to stop</p>
        </div>
    </div>

    <style>
        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.3); opacity: 0.9; }
        }
    </style>
</body>
</html>
